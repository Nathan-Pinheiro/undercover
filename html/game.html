<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/default_style.css">
    <link rel="stylesheet" href="css/game_style.css">
    <link rel="stylesheet" href="css/settings_panel_style.css">
    <link rel="stylesheet" href="css/winner_panel_style.css">
    <title>Undercover</title>
</head>

<body class="container-fluid">
    <header class="row align-items-center justify-content-center m-0">
        <h1 id="title" class="text-center"></h1>
        <h1 id="subtitle" class="text-center"></h1>
    </header>
    <div id="waiting_screen" class="hidden">
        <img src="../resources/undercover_icon.png" alt="undercover_icon">
        <h1 id="waiting_screen_title">...</h1>
    </div>
    <div id="game_content">
        <div class="player_row" id="player_row_1">
            <div id="player1" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_2">
            <div id="player2" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-right p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
            <div id="sep1" class="separator"></div>
            <div id="player3" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_3">
            <div id="player4" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
            <div id="sep2" class="separator"></div>
            <div id="player5" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_4">
            <div id="player6" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
            <div id="sep3" class="separator"></div>
            <div id="player7" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_5">
            <div id="player8" class="player">
                <img class="player_icon" src="./resources/unknow.png" alt="">
                <h3 class="player_name"></h3>
                <div class="talks talks-left p-1">
                    <p></p>
                    <h5>...</h5>
                </div>
                <img src="./resources/hand_cursor.png" alt="" class="hand_cursor">
                <div class="player_score hidden">
                    <span class="player_score_value"></span><span class="reward_score_value"></span>
                </div>
            </div>
        </div>
    </div>
</body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var room_id = localStorage.getItem("roomId");
        var player_name = localStorage.getItem("player_name");
        var player_icon = localStorage.getItem("player_icon");

        var player_id = -1;
        var is_host = false;

        var selected_player_id = undefined;

        var socket = io();

        socket.emit("joinRoom", room_id, player_name, player_icon)
        console.log(`Joined room : ${room_id}`);

        socket.on("errorMessage", (message) =>
        {
            console.error(message);
        });

        socket.on("sendMessage", (message) =>
        {
            console.log(message);
        });

        socket.on("sendRoomData", (data) =>
        {
            player_id = -1
            for (let i = 0; i < data.players.length; i++)
                if(data.players[i].player_name == player_name) player_id = i;

            is_host = data.host == player_name;

            updateUI(data);
        });

        function show_waiting_screen(waiting_screen_title_text)
        {
            var waiting_screen = document.getElementById("waiting_screen");
            waiting_screen.classList.remove("hidden");

            var waiting_screen_title = document.getElementById("waiting_screen_title");
            waiting_screen_title.textContent = waiting_screen_title_text;
        }

        function hide_waiting_screen()
        {
            var waiting_screen = document.getElementById("waiting_screen");
            waiting_screen.classList.add("slideout");

            setTimeout(() => {
                waiting_screen.classList.remove("slideout");
                waiting_screen.classList.add("hidden");
            }, 3000);
        }

    </script>
    <script src="/html/builders/confirmButtonBuilder.js" type="module"></script>
    <script src="/html/builders/goToVoteButtonBuilder.js" type="module"></script>
    <script src="/html/builders/hostBarBuilder.js" type="module"></script>
    <script src="/html/builders/wordSendBarBuilder.js" type="module"></script>
    <script src="/html/builders/finalPodiumPanelBuilder.js" type="module"></script>
    <script src="/html/builders/rolesPanelBuilder.js" type="module"></script>
    <script src="/html/builders/gameSettingsPanelBuilder.js" type="module"></script>
    <script src="/html/builders/nextTurnButtonBuilder.js" type="module"></script>
    <script src="/html/listeners.js" type="module"></script>
    <script>
        const title = document.getElementById("title");
        const subtitle = document.getElementById("subtitle");

        function updateUI(data)
        {
            if(document.getElementById("send_word_bar")) document.getElementById("send_word_bar").remove();
            if(document.getElementById("go_to_vote_button")) document.getElementById("go_to_vote_button").remove();
            if(document.getElementById("confirm_vote_button")) document.getElementById("confirm_vote_button").remove();
            if(document.getElementById("winners_panel")) document.getElementById("winners_panel").remove();
            if(document.getElementById("game_settings_panel")) document.getElementById("game_settings_panel").remove();
            if(document.getElementById("next_turn_button")) document.getElementById("next_turn_button").remove();

            updatePlayersUI(data);

            if(document.getElementById("host_bar")) document.getElementById("host_bar").remove();
            if(is_host && data.game_state == 0)
            {
                document.body.appendChild(build_host_bar(socket, data.game_settings));
            }

            switch (data.game_state)
            {
                case 0:

                    title.textContent = "Room ID";
                    subtitle.textContent = room_id;
                    break;

                case 1:
                case 2:

                    let round_just_started = true;
                    for (let i = 0; i < data.players.length; i++)
                    {
                        if(data.players[i].words.length != 0)
                        {
                            round_just_started = false;
                            break;
                        }
                    }

                    if(round_just_started)
                    {
                        if(data.round == 1) show_waiting_screen("La partie commence !");
                        else show_waiting_screen("Nouveau tour !");

                        setTimeout(() => {
                            hide_waiting_screen();
                        }, 2000);
                    }

                    subtitle.textContent = "Tour " + data.round + "/" + data.game_settings.max_round;
                    if(data.players[player_id]) title.textContent = data.players[player_id].word;
                    else title.textContent = "<mot>";
                    break;

                case 3:

                    if(data.players[player_id].vote == undefined)
                    {
                        show_waiting_screen("Passons aux votes !");

                        setTimeout(() => {
                            hide_waiting_screen();
                        }, 2000);
                    }

                    title.textContent = "Votez !";
                    subtitle.textContent = "Tour " + data.round + "/" + data.game_settings.max_round;
                    if(data.players[player_id].vote == undefined) document.body.appendChild(build_confirm_button(player_id));
                    break;

                case 4:

                    default_word = data.default_word;
                    undercover_word = data.undercover_word;

                    title.textContent = "Fin du round";
                    subtitle.innerHTML = "Mots : <h1 class='default_word'>" + default_word + "</h1> / <h1 class='undercover_word'>" + undercover_word + "</h1>";

                    if(is_host) document.body.appendChild(build_next_turn_button(socket))

                    break;

                case 5:

                    title.textContent = "";
                    subtitle.textContent = "";

                    data.players.sort((a, b) => b.score - a.score);
                    const winner = data.players.slice(0, 3);

                    if(is_host) document.body.appendChild(build_host_winners_panel(socket, winner));
                    else document.body.appendChild(build_winners_panel(winner));
                    break;

                default:
                    console.error("Ce game state n'existe pas !");
                    break;
            }
            console.log("UI is up to date !");
        }

        function updatePlayersUI(data)
        {
            const players = data.players;
            const turn = data.turn;
            const game_state = data.game_state;

            var coef;
            if(data.players.length <= 3) coef = 4;
            else if(players.length <= 5) coef = 3;
            else if(players.length <= 7) coef = 1.7;
            else coef = 1.5;

            var pading_top;
            if(players.length >= 8) pading_top = [0, 0, 15, 30, 45];
            else if(players.length > 6) pading_top = [0, 0, 15, 30, 0];
            else if(players.length > 4) pading_top = [0, 0, 15, 0, 0];
            else pading_top = [0, 0, 0, 0, 0];

            const row_amount = 5
            const base_top_vh_values = [3, 7, 13, 19, 21];
            const base_top_px_values = [85, 85, 105, 125, 145];

            for (let i = 0; i < row_amount; i++)
            {
                const player_row = document.getElementById("player_row_" + (i+1));
                const new_top_value = "calc(" + (base_top_px_values[i] + pading_top[i])+ "px + " + (base_top_vh_values[i] * coef) + "vh)";
                player_row.style.top = new_top_value;
            }

            for (let i = 0; i < players.length; i++)
            {
                const player = players[i];
                const player_div = getPlayerDiv(i);
                const player_name = player_div.querySelector("h3");
                const player_icon = player_div.querySelector("img");
                const player_score = player_div.getElementsByClassName("player_score")[0];
                const player_score_value = player_score.getElementsByClassName("player_score_value")[0];
                const reward_score_value = player_score.getElementsByClassName("reward_score_value")[0];
                const talks = player_div.querySelector(".talks");
                const message = talks.querySelector("p");

                player_icon.src = player.player_icon;
                player_name.textContent = player.player_name;
                if(i == player_id) player_name.classList.add("personnal_player_name")

                player_div.onmouseenter = undefined;
                player_div.onmouseleave = undefined;
                player_div.onclick = undefined;

                talks.classList.remove("justTalked");
                talks.classList.remove("isTalking");
                player_div.classList.remove("selected");
                player_div.classList.remove("hovered");

                if(!player_score.classList.contains("hidden")) player_score.classList.add("hidden");

                switch (game_state)
                {
                    case 0:
                        break;

                    case 1:
                    case 2:

                        if(player.is_talking)
                        {
                            talks.classList.add("isTalking");
                        }
                        else if (player.just_talked)
                        {
                            message.textContent = player.words[player.words.length - 1];
                            talks.classList.add("justTalked");
                        }
                        if(i == player_id)
                        {
                            if(player.is_talking) document.body.appendChild(build_word_send_bar());
                            else if(is_host) document.body.appendChild(build_go_to_vote_button());
                            if(player.is_undercover && data.game_settings.show_undercover_icon) add_undercover_icon(player_name);
                        }
                        break;

                    case 3:

                        if(players[player_id].vote == undefined && i !== player_id)
                        {
                            player_div.onmouseenter = function() { onMouseOverPlayer(player_div); };
                            player_div.onmouseleave = function() { onMouseExitedPlayer(player_div); };
                            player_div.onclick = function() { onClickPlayer(i, players.length); };
                        }

                        if(i == player_id && player.is_undercover && data.game_settings.show_undercover_icon) add_undercover_icon(player_name);

                        break;

                    case 4:

                        player_score.classList.remove("hidden");

                        if(data.rewards != undefined && data.rewards[i] != undefined)
                        {
                            player_score_value.textContent = player.score;
                            reward_score_value.textContent = " + " + data.rewards[i];

                            setTimeout(() => {
                                animate_score_update(players[i].score, data.rewards[i], player_score_value, reward_score_value);
                            }, 900);
                        }

                        if(player.is_undercover) add_undercover_icon(player_name);

                        break;

                    case 5:
                        break;

                    default:
                        console.error("Ce game state n'existe pas !");
                        break;
                }
            }

            for (let i = 4; i <= 8; i++)
            {
                let playerId = 'player' + i;
                if (i > players.length) document.getElementById(playerId).classList.add("hidden");
                else document.getElementById(playerId).classList.remove("hidden");
            }

            if (players.length < 2) document.getElementById("player2").style.opacity = 0.8
            else document.getElementById("player2").style.opacity = 1

            if (players.length < 3) document.getElementById("player3").style.opacity = 0.8
            else document.getElementById("player3").style.opacity = 1

            if (players.length < 5) document.getElementById("sep2").classList.add("hidden");
            else document.getElementById("sep2").classList.remove("hidden");

            if (players.length < 7) document.getElementById("sep3").classList.add("hidden");
            else document.getElementById("sep3").classList.remove("hidden");

        }

        function getPlayerDiv(turn)
        {
            let player_id = 'player' + (turn + 1)
            let player_div = document.getElementById(player_id);
            return player_div;
        }

        function add_undercover_icon(player_name_div)
        {
            var player_name = player_name_div.textContent
            player_name_div.innerHTML = `<img class="undercover_icon" src="../resources/undercover_icon.png" alt="undercover_icon"> ${player_name}`
        }

        function animate_score_update(player_score, reward, player_score_value, reward_score_value)
        {
            const start_time = performance.now();
            const frame_duration = 1000 / 60;

            function animate(currentTime)
            {
                const elapsed_time = currentTime - start_time;
                const progress = Math.min(elapsed_time / 2000, 1);

                const easing_progress = easeInOutQuad(progress);
                const new_player_score = Math.round(player_score + easing_progress * reward);
                const new_reward_score = " + " + Math.round(reward * (1 - easing_progress));

                player_score_value.textContent = new_player_score;
                reward_score_value.textContent = new_reward_score;

                if (progress < 1)
                {
                    requestAnimationFrame(animate);
                }
            }

            requestAnimationFrame(animate);
        }

        function easeInOutQuad(t)
        {
            return t < 0.5 ? 2 * t * t : -1 + ((4 - (2 * t)) * t);
        }

    </script>
</body>

</html>