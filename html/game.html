<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/default_style.css">
    <link rel="stylesheet" href="css/game_style.css">
    <link rel="stylesheet" href="css/settings_panel_style.css">
    <link rel="stylesheet" href="css/winner_panel_style.css">
    <title>Undercover</title>
</head>

<body class="container-fluid">
    <header class="row align-items-center justify-content-center m-0">
        <h2 id="title" class="text-center">Votre Mot :</h2>
        <h1 id="subtitle" class="text-center">Ch√¢teau</h1>
    </header>
    <div id="game_content">
        <div class="player_row" id="player_row_1">
            <div id="player1" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_2">
            <div id="player2" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-right p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
            <div id="sep1" class="separator"></div>
            <div id="player3" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_3">
            <div id="player4" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
            <div id="sep2" class="separator"></div>
            <div id="player5" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_4">
            <div id="player6" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
            <div id="sep3" class="separator"></div>
            <div id="player7" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="player_row" id="player_row_5">
            <div id="player8" class="player">
                <div class="colored-background rounded-circle">
                    <img src="./resources/unknow.png" alt="">
                    <h3 class="player_name"></h3>
                    <div class="talks talks-left p-1">
                        <p></p>
                        <h5>...</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var room_id = localStorage.getItem("roomId");
        var player_name = localStorage.getItem("player_name");
        var player_icon = localStorage.getItem("player_icon");

        var player_id = -1;
        var is_host = false;

        var selected_player_id = undefined;

        var socket = io();

        socket.emit("joinRoom", room_id, player_name, player_icon)
        console.log(`Joined room : ${room_id}`);

        socket.on("errorMessage", (message) =>
        {
            console.error(message);
        });

        socket.on("sendMessage", (message) =>
        {
            console.log(message);
        });

        socket.on("sendRoomData", (data) =>
        {
            player_id = -1
            for (let i = 0; i < data.players.length; i++)
                if(data.players[i].player_name == player_name) player_id = i;

            is_host = data.host == player_name;
            updateUI(data);
        });

    </script>
    <script src="/html/builders/confirmButtonBuilder.js" type="module"></script>
    <script src="/html/builders/goToVoteButtonBuilder.js" type="module"></script>
    <script src="/html/builders/hostBarBuilder.js" type="module"></script>
    <script src="/html/builders/rewardPanelBuilder.js" type="module"></script>
    <script src="/html/builders/wordSendBarBuilder.js" type="module"></script>
    <script src="/html/builders/finalPodiumPanelBuilder.js" type="module"></script>
    <script src="/html/builders/rolesPanelBuilder.js" type="module"></script>
    <script src="/html/builders/gameSettingsPanelBuilder.js" type="module"></script>
    <script src="/html/listeners.js" type="module"></script>
    <script>
        const title = document.getElementById("title");
        const subtitle = document.getElementById("subtitle");

        function updateUI(data)
        {
            if(document.getElementById("send_word_bar")) document.getElementById("send_word_bar").remove();
            if(document.getElementById("go_to_vote_button")) document.getElementById("go_to_vote_button").remove();
            if(document.getElementById("confirm_vote_button")) document.getElementById("confirm_vote_button").remove();
            if(document.getElementById("reward_panel")) document.getElementById("reward_panel").remove();
            if(document.getElementById("winners_panel")) document.getElementById("winners_panel").remove();
            if(document.getElementById("game_settings_panel")) document.getElementById("game_settings_panel").remove();

            updatePlayersUI(data.players, data.turn, data.game_state);

            if(document.getElementById("host_bar")) document.getElementById("host_bar").remove();
            if(is_host && data.game_state == 0)
            {
                document.body.appendChild(build_host_bar(socket, data.game_settings));
            }

            switch (data.game_state)
            {
                case 0:

                    title.textContent = "Room ID";
                    subtitle.textContent = room_id;
                    break;

                case 1:
                case 2:

                    title.textContent = "Tour " + data.round + "/" + data.game_settings.max_round;
                    if(data.players[player_id]) subtitle.textContent = data.players[player_id].word;
                    else subtitle.textContent = "<mot>";
                    break;

                case 3:

                    title.textContent = "Tour " + data.round + "/" + data.game_settings.max_round;
                    subtitle.textContent = "Votez !";
                    if(data.players[player_id].vote == undefined) document.body.appendChild(build_confirm_button(player_id));
                    break;

                case 4:

                    title.textContent = "";
                    subtitle.textContent = "";

                    if(data.rewards != undefined)
                    {
                        if(is_host) document.body.appendChild(build_host_reward_panel(socket, data.rewards, data.players));
                        else document.body.appendChild(build_reward_panel(data.rewards, data.players));
                    }

                    break;

                case 5:

                    title.textContent = "";
                    subtitle.textContent = "";

                    data.players.sort((a, b) => b.score - a.score);
                    const winner = data.players.slice(0, 3);

                    if(is_host) document.body.appendChild(build_host_winners_panel(socket, winner));
                    else document.body.appendChild(build_winners_panel(winner));
                    break;

                default:
                    console.error("Ce game state n'existe pas !");
                    break;
            }
            console.log("UI is up to date !");
        }

        function updatePlayersUI(players, turn, game_state)
        {
            var coef;
            if(players.length <= 3) coef = 4;
            else if(players.length <= 5) coef = 3;
            else if(players.length <= 7) coef = 1.7;
            else coef = 1.5;

            var pading_top;
            if(players.length >= 8) pading_top = [0, 0, 15, 30, 45];
            else if(players.length > 6) pading_top = [0, 0, 15, 30, 0];
            else if(players.length > 4) pading_top = [0, 0, 15, 0, 0];
            else pading_top = [0, 0, 0, 0, 0];

            const row_amount = 5
            const base_top_vh_values = [3, 7, 13, 19, 21];
            const base_top_px_values = [85, 85, 105, 125, 145];

            for (let i = 0; i < row_amount; i++)
            {
                const player_row = document.getElementById("player_row_" + (i+1));
                const new_top_value = "calc(" + (base_top_px_values[i] + pading_top[i])+ "px + " + (base_top_vh_values[i] * coef) + "vh)";
                player_row.style.top = new_top_value;
            }

            for (let i = 0; i < players.length; i++)
            {
                const player = players[i];
                const player_div = getPlayerDiv(i);
                const player_name = player_div.querySelector("h3");
                const player_icon = player_div.querySelector("img")
                const colored_backround = player_div.querySelector(".colored-background");
                const talks = player_div.querySelector(".talks");
                const message = talks.querySelector("p");

                player_icon.src = player.player_icon;
                player_name.textContent = player.player_name;
                if(i == player_id) player_name.classList.add("personnal_player_name")

                colored_backround.onmouseenter = undefined;
                colored_backround.onmouseleave = undefined;
                colored_backround.onclick = undefined;

                talks.classList.remove("justTalked");
                talks.classList.remove("isTalking");
                colored_backround.classList.remove("selected");
                colored_backround.classList.remove("hovered");

                switch (game_state)
                {
                    case 0:
                        break;

                    case 1:
                    case 2:

                        if(player.is_talking)
                        {
                            talks.classList.add("isTalking");
                        }
                        else if (player.just_talked)
                        {
                            message.textContent = player.words[player.words.length - 1];
                            talks.classList.add("justTalked");
                        }
                        if(i == player_id)
                        {
                            if(player.is_talking) document.body.appendChild(build_word_send_bar());
                            else if(is_host) document.body.appendChild(build_go_to_vote_button());
                        }
                        break;

                    case 3:

                        if(players[player_id].vote == undefined && i !== player_id)
                        {
                            colored_backround.onmouseenter = function() { onMouseOverPlayer(colored_backround); };
                            colored_backround.onmouseleave = function() { onMouseExitedPlayer(colored_backround); };
                            colored_backround.onclick = function() { onClickPlayer(i, players.length); };
                        }
                        break;

                    case 4:
                        break;

                    case 5:
                        break;

                    default:
                        console.error("Ce game state n'existe pas !");
                        break;
                }
            }

            for (let i = 4; i <= 8; i++)
            {
                let playerId = 'player' + i;
                if (i > players.length) document.getElementById(playerId).classList.add("hidden");
                else document.getElementById(playerId).classList.remove("hidden");
            }

            if (players.length < 2) document.getElementById("player2").style.opacity = 0.8
            else document.getElementById("player2").style.opacity = 1

            if (players.length < 3) document.getElementById("player3").style.opacity = 0.8
            else document.getElementById("player3").style.opacity = 1

            if (players.length < 5) document.getElementById("sep2").classList.add("hidden");
            else document.getElementById("sep2").classList.remove("hidden");

            if (players.length < 7) document.getElementById("sep3").classList.add("hidden");
            else document.getElementById("sep3").classList.remove("hidden");

        }

        function getPlayerDiv(turn)
        {
            let player_id = 'player' + (turn + 1)
            let player_div = document.getElementById(player_id);
            return player_div;
        }

    </script>
</body>

</html>